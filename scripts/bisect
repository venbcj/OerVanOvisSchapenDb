#!/usr/bin/env bash
set -euo pipefail

PHPUNIT="vendor/bin/phpunit"
FAILING_TEST=$1
LIST="tests.list"

mapfile -t TESTS < "$LIST"

low=0
high=${#TESTS[@]}

echo "Bisecting ${#TESTS[@]} tests..."

while (( low < high )); do
  mid=$(( (low + high) / 2 ))

  echo "â–¶ Testing with $mid preceding tests"

  {
    for ((i=0; i<mid; i++)); do
      echo "${TESTS[$i]}"
    done
    echo "$FAILING_TEST"
  } > subset.list

  if $PHPUNIT --testsuite default --filter "$(paste -sd'|' subset.list)" > /dev/null 2>&1; then
    # Test PASSED â†’ need more pollution
    low=$((mid + 1))
  else
    # Test FAILED â†’ culprit is in this half
    high=$mid
  fi
done

echo
echo "ğŸ’¥ Minimal failing prefix size: $low"
echo "ğŸ” Suspect test:"
echo "  ${TESTS[$((low - 1))]}"

