#!/bin/bash
if [ -z "$1" ]; then
    echo synopsis: $0 classname
    echo Leave out 'GatewayTest' suffix
    exit
fi
TESTFILE=tests/unit/$1GatewayTest.php
PHPFILE=gateways/$1Gateway.php
if [ ! -f $TESTFILE ]; then
    CLASSNAME=$1GatewayTest
    cat << TXT > $TESTFILE
<?php

class $CLASSNAME extends GatewayCase {

    protected static \$sutname = '$1Gateway';

TXT

grep -E '^\s*public function ' "$PHPFILE" \
| grep -v '__construct' \
| while read -r line; do

METHOD=$(sed -E 's/.*public function ([^(]+)\(.*/\1/' <<< "$line")
PARAMS_RAW=$(sed -E 's/.*public function [^(]+\(([^)]*)\).*/\1/' <<< "$line")
PARAM_VARS=$(grep -o '\$[a-zA-Z_][a-zA-Z0-9_]*' <<< "$PARAMS_RAW")
CALL_ARGS=$(echo "$PARAM_VARS" | sed ':a;N;$!ba;s/\n/, /g')
INIT_LINES=$(echo "$PARAM_VARS" | sed 's/^\(.\+\)$/\1 = null;/' | sed 's/\(.*\)/        \1/')

    cat << TXT >> $TESTFILE
    public function test_${METHOD}() {
$INIT_LINES
        \$result = \$this->sut->$METHOD($CALL_ARGS);
        \$this->assertNotFalse(\$result);
    }

TXT
done
echo '}' >> $TESTFILE
echo $TESTFILE
fi
tmux split-window -h -l80 "cover-include none; cover-include gateways; cover on; ./watcher $TESTFILE"
vi -o $TESTFILE gateways/$1Gateway.php
